<!doctype html>
<html lang="es-MX">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NORA ‚Äì Manejo de crisis y factor humano (Bandersnatch dicot√≥mico)</title>
  <style>
    :root{
      --bg:#0b1220; --card:#121b2f; --muted:#8aa0c8; --text:#e9f0ff;
      --ok:#2dd4bf; --warn:#fbbf24; --bad:#fb7185; --btn:#223152; --btn2:#2b3b63;
    }
    body{margin:0;background:linear-gradient(180deg,var(--bg),#070b14);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);}
    .wrap{max-width:920px;margin:0 auto;padding:18px;}
    .header{display:flex;gap:12px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;}
    h1{font-size:18px;margin:0 0 6px 0;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:13px;line-height:1.35;margin:0}
    .pill{display:inline-block;border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:12px}
    .card{background:rgba(18,27,47,.9);border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:16px;margin-top:14px;box-shadow:0 12px 30px rgba(0,0,0,.25)}
    .row{display:flex;gap:14px;flex-wrap:wrap}
    .col{flex:1;min-width:260px}
    .label{color:var(--muted);font-size:12px;margin:0 0 8px 0}
    .scenario{font-size:15px;line-height:1.5;margin:0}
    .meta{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
    .meta div{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:8px 10px;font-size:12px;color:var(--muted)}
    .choices{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    button{
      appearance:none;border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg,var(--btn),var(--btn2));
      color:var(--text);border-radius:14px;padding:12px 12px;
      font-size:14px;line-height:1.25;cursor:pointer;flex:1;min-width:260px;
    }
    button:active{transform:translateY(1px)}
    .feedback{margin-top:14px;border-radius:14px;padding:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04)}
    .fb-title{display:flex;align-items:center;gap:10px;margin:0 0 6px 0;font-weight:650}
    .tag{font-size:12px;border-radius:999px;padding:2px 8px;border:1px solid rgba(255,255,255,.16);color:var(--muted)}
    .fb-body{margin:0;color:var(--text);line-height:1.45;font-size:14px}
    .hr{height:1px;background:rgba(255,255,255,.10);margin:14px 0}
    .small{font-size:12px;color:var(--muted);line-height:1.4}
    .footer-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .ghost{background:transparent}
    .log{max-height:220px;overflow:auto;border:1px dashed rgba(255,255,255,.16);border-radius:14px;padding:10px;background:rgba(0,0,0,.12)}
    .log p{margin:0 0 8px 0;font-size:12px;color:var(--muted);line-height:1.35}
    .kpi{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .kpi span{font-size:12px;color:var(--muted);border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:4px 8px;background:rgba(255,255,255,.04)}
    .endbox{border-left:4px solid rgba(45,212,191,.6);padding-left:12px}
    .warnline{border-left-color:rgba(251,191,36,.7)}
    .badline{border-left-color:rgba(251,113,133,.7)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1>NORA ‚Äì Crisis en sala fuera de quir√≥fano (factor humano + manejo de crisis)</h1>
        <p class="sub">
          Interactivo dicot√≥mico (A/B), orientado a toma de decisiones realistas, CRM y seguridad.
          Dise√±ado para correr en celular, sin internet.
        </p>
      </div>
      <div class="pill">Modo: Bandersnatch</div>
    </div>

    <div class="card">
      <div class="row">
        <div class="col">
          <p class="label">Escenario</p>
          <p id="scene" class="scenario"></p>

          <div id="meta" class="meta"></div>

          <div class="choices">
            <button id="aBtn"></button>
            <button id="bBtn"></button>
          </div>

          <div id="fb" class="feedback" style="display:none;">
            <div class="fb-title">
              <span id="fbEmoji">üß≠</span>
              <span id="fbTitle">Retroalimentaci√≥n</span>
              <span id="fbTag" class="tag"></span>
            </div>
            <p id="fbBody" class="fb-body"></p>
          </div>

          <div class="footer-actions">
            <button class="ghost" id="restartBtn">Reiniciar caso</button>
            <button class="ghost" id="toggleLogBtn">Mostrar/ocultar bit√°cora</button>
          </div>

          <div class="hr"></div>
          <p class="small">
            Nota did√°ctica: La retroalimentaci√≥n evita ‚Äúorientar al error‚Äù; se enfoca en seguridad, trade-offs,
            y en c√≥mo estructurar el equipo/decisi√≥n bajo presi√≥n (factor humano).
          </p>
        </div>

        <div class="col">
          <p class="label">Bit√°cora de decisiones (para debriefing r√°pido)</p>
          <div id="log" class="log" style="display:none;"></div>
          <div class="kpi" id="kpis"></div>
        </div>
      </div>
    </div>

    <div class="card" id="debriefCard" style="display:none;">
      <p class="label">Debriefing estructurado</p>
      <div id="debrief" class="endbox"></div>
    </div>
  </div>

<script>
/*
  Caso: NORA (RM / Intervencionismo) ‚Äì sedaci√≥n profunda con propofol/opi√°ceo, v√≠a a√©rea compartida/no ideal,
  evento de hipoventilaci√≥n -> desaturaci√≥n y colapso hemodin√°mico incipiente.
  Objetivo: decisiones dicot√≥micas repetidas, pero con trayecto largo.
*/

const state = {
  step: "S0",
  log: [],
  kpi: {
    LlamarAyuda: 0,
    Liderazgo: 0,
    ClosedLoop: 0,
    Reevaluacion: 0,
    SeguridadNORA: 0,
    Checklists: 0
  }
};

function addLog(txt){
  state.log.push(txt);
  renderLog();
}

function bump(k){ state.kpi[k] = (state.kpi[k]||0) + 1; renderKpi(); }

function tagFor(kind){
  if(kind==="seguridad") return {emoji:"üõ°Ô∏è", tag:"Seguridad / NORA"};
  if(kind==="crm") return {emoji:"üß†", tag:"CRM / factor humano"};
  if(kind==="clinica") return {emoji:"ü´Å", tag:"Cl√≠nico (ABCD)"};
  if(kind==="equipo") return {emoji:"üë•", tag:"Equipo / roles"};
  if(kind==="proceso") return {emoji:"üßæ", tag:"Proceso / checklist"};
  return {emoji:"üß≠", tag:"Decisi√≥n"};
}

const nodes = {
  S0: {
    scene: `Est√°s en <b>Radiolog√≠a intervencionista (NORA)</b>. Paciente masculino 58 a√±os, IMC 34, SAOS sospechada (roncador), HTA controlada.
    Procedimiento: <b>embolizaci√≥n</b> (duraci√≥n estimada 90 min). Sedaci√≥n planificada con propofol TCI (o infusi√≥n) + analgesia titulada.
    Acceso al paciente limitado (campos, arco en C, cables). Monitorizaci√≥n: ECG, PANI c/3 min, SpO‚ÇÇ, capnograf√≠a por c√°nula nasal disponible.`,
    meta: [
      "Riesgos: SAOS, acceso limitado, ventilaci√≥n dif√≠cil",
      "Entorno NORA: recursos variables, ayuda a distancia",
      "Objetivo: mantener seguridad y rescate de v√≠a a√©rea"
    ],
    A: {
      txt: "Antes de iniciar, haces ‚Äúbrief‚Äù de 60‚Äì90 s: roles, plan A/B de v√≠a a√©rea, umbrales de llamada, y confirmas equipo/ox√≠geno/succi√≥n/capnograf√≠a.",
      to: "S1",
      fb: {
        kind:"crm",
        title:"Organizas el sistema antes del problema",
        body:"En NORA, la seguridad se gana temprano: alinear expectativas, roles, recursos, y criterios de escalamiento reduce latencia decisional. Este tipo de brief es de alto rendimiento y bajo costo de tiempo.",
        kpi:["Liderazgo","SeguridadNORA","Checklists"]
      }
    },
    B: {
      txt: "Inicias de inmediato (el equipo presiona por tiempo). Revisas equipo ‚Äúsobre la marcha‚Äù mientras comienzas sedaci√≥n.",
      to: "S1",
      fb: {
        kind:"seguridad",
        title:"Aceptas presi√≥n operativa sin contramedidas",
        body:"Puede ser frecuente en NORA, pero incrementa riesgo de omisiones (ox√≠geno, succi√≥n, plan de rescate, comunicaci√≥n). No es ‚Äúincorrecto‚Äù per se; el costo oculto es que, si ocurre una crisis, el equipo no comparte el mismo modelo mental.",
        kpi:[]
      }
    }
  },

  S1: {
    scene: `Minuto 18. El procedimiento va estable, pero el paciente empieza a roncar. Capnograf√≠a muestra onda irregular con periodos de hipoventilaci√≥n.
    SpO‚ÇÇ baja de 98% a 93%. FC 78, PANI 128/76. El radi√≥logo pide ‚Äúun poco m√°s de sedaci√≥n porque se mueve‚Äù.`,
    meta: ["Se√±al temprana: ventilaci√≥n inestable", "Riesgo de espiral sedaci√≥n‚Äìobstrucci√≥n", "Capnograf√≠a ya te avis√≥"],
    A: {
      txt: "Priorizas ventilaci√≥n: reduces/titulas sedaci√≥n, reposicionas cabeza/mand√≠bula, aumentas O‚ÇÇ, confirmas capnograf√≠a y pides pausa breve al operador.",
      to: "S2",
      fb: {
        kind:"clinica",
        title:"Tratas el problema temprano (ABCD pragm√°tico)",
        body:"La capnograf√≠a te dio diagn√≥stico funcional: ventilaci√≥n comprometida antes de la desaturaci√≥n severa. Intervenir temprano suele evitar rescates m√°s invasivos y disminuye interrupciones mayores del procedimiento.",
        kpi:["Reevaluacion","SeguridadNORA"]
      }
    },
    B: {
      txt: "Aumentas sedaci√≥n para ‚Äúevitar movimiento‚Äù y esperas que el ox√≠geno por c√°nula compense.",
      to: "S2",
      fb: {
        kind:"clinica",
        title:"Priorizas inmovilidad sobre fisiolog√≠a",
        body:"Es una tensi√≥n real en NORA. El riesgo es profundizar la obstrucci√≥n/hipoventilaci√≥n, generando una crisis m√°s abrupta con acceso limitado al paciente. Si decides sedaci√≥n mayor, el plan de rescate debe adelantarse de inmediato.",
        kpi:[]
      }
    }
  },

  S2: {
    scene: `Minuto 21. SpO‚ÇÇ cae a 86% en 30‚Äì45 s. Capnograf√≠a se aplana intermitente. El paciente est√° somnoliento, con tiraje leve; el acceso a la cabeza est√° parcialmente bloqueado por el arco en C.
    El t√©cnico dice: ‚Äúpara mover el arco necesito 20 segundos‚Äù.`,
    meta: ["Desaturaci√≥n r√°pida", "Acceso limitado", "Necesitas aire ahora"],
    A: {
      txt: "Das instrucci√≥n clara: ‚ÄúPausa, retirar arco en C ya. Yo manejo v√≠a a√©rea.‚Äù Inicias maniobras de v√≠a a√©rea (jaw thrust + sellado con mascarilla o dispositivo disponible) y pides ayuda.",
      to: "S3",
      fb: {
        kind:"equipo",
        title:"Liderazgo expl√≠cito y liberaci√≥n de acceso",
        body:"En crisis, la prioridad es crear condiciones para ventilar: acceso, ox√≠geno, succi√≥n y manos. Un comando claro, con prioridad declarada, reduce confusi√≥n y acelera acciones paralelas.",
        kpi:["Liderazgo","LlamarAyuda","ClosedLoop","SeguridadNORA"]
      }
    },
    B: {
      txt: "Intentas ‚Äúhacer algo‚Äù sin pedir pausa formal ni mover el arco; te estiras para ventilar con acceso parcial mientras el procedimiento contin√∫a.",
      to: "S3",
      fb: {
        kind:"seguridad",
        title:"Act√∫as con restricci√≥n f√≠sica no resuelta",
        body:"En NORA, intentar rescate sin acceso completo suele alargar el tiempo sin ventilaci√≥n efectiva. No es raro que ocurra; la intervenci√≥n de factor humano es declarar prioridad y detener lo que impide ventilar.",
        kpi:[]
      }
    }
  },

  S3: {
    scene: `Minuto 22. Ya con acceso a la cabeza. Ventilas con mascarilla: hay resistencia y fuga. SpO‚ÇÇ 82% ‚Üí 79%.
    Auscultaci√≥n r√°pida dif√≠cil por ruido. Secreciones m√≠nimas. El patr√≥n sugiere obstrucci√≥n de v√≠a a√©rea superior y/o laringoespasmo parcial.`,
    meta: ["Necesitas ventilaci√≥n efectiva", "Tiempo cr√≠tico", "Decidir escalamiento"],
    A: {
      txt: "Optimizaci√≥n sistem√°tica: 2 manos con mascarilla + OPA/NPA (si no contraindicada), PEEP moderada, y pides que alguien cuente en voz alta la saturaci√≥n/tiempo mientras t√∫ reevaluas.",
      to: "S4",
      fb: {
        kind:"crm",
        title:"Estandarizas y reduces carga cognitiva",
        body:"Optimizar lo b√°sico primero es eficiente. Pedir que alguien verbalice valores/tiempo y mantener comunicaci√≥n en bucle cerrado mejora conciencia situacional y reduce fijaci√≥n atencional.",
        kpi:["ClosedLoop","Reevaluacion"]
      }
    },
    B: {
      txt: "Escalas de inmediato a intubaci√≥n sin intentar optimizaci√≥n con dos manos/adyuvantes (te preocupa perder tiempo).",
      to: "S4",
      fb: {
        kind:"clinica",
        title:"Escalas r√°pido (v√°lido si anticipas fracaso de bolsa-mascarilla)",
        body:"La intubaci√≥n puede ser apropiada, pero en NORA la intubaci√≥n tambi√©n consume tiempo/log√≠stica. Si la ventilaci√≥n con mascarilla a√∫n no se intent√≥ de forma √≥ptima, podr√≠as perder una intervenci√≥n de alto rendimiento. El punto clave es justificarlo y preparar el plan B/C.",
        kpi:[]
      }
    }
  },

  S4: {
    scene: `Minuto 23. Con OPA y 2 manos, la ventilaci√≥n mejora parcialmente. Capnograf√≠a regresa con ondas peque√±as. SpO‚ÇÇ sube a 84%‚Üí88%.
    El radi√≥logo pregunta: ‚Äú¬øPodemos seguir? estamos justo en el paso cr√≠tico‚Äù.`,
    meta: ["Mejor√≠a parcial", "Presi√≥n del procedimiento", "Riesgo de reca√≠da si contin√∫as igual"],
    A: {
      txt: "Defines umbral: ‚ÄúReanudamos solo si SpO‚ÇÇ > 94% estable + capnograf√≠a adecuada + plan de sedaci√≥n ajustado.‚Äù Pides pausa adicional y propones alternativa (LMA/GA, o menor sedaci√≥n con mejor soporte).",
      to: "S5",
      fb: {
        kind:"seguridad",
        title:"Criterios expl√≠citos para reanudar",
        body:"La decisi√≥n no es ‚Äúseguir o no‚Äù; es ‚Äúbajo qu√© condiciones seguras‚Äù. Establecer umbrales reduce negociaci√≥n improvisada y protege al paciente ante recidiva. En NORA, cambiar el plan (dispositivo supragl√≥tico/GA) puede ser la opci√≥n m√°s segura.",
        kpi:["Liderazgo","SeguridadNORA","Reevaluacion"]
      }
    },
    B: {
      txt: "Accedes a continuar de inmediato para no ‚Äúperder el momento‚Äù, manteniendo el mismo esquema de sedaci√≥n con peque√±os ajustes.",
      to: "S5",
      fb: {
        kind:"crm",
        title:"Priorizas continuidad operativa",
        body:"Puede ser comprensible, pero el riesgo es volver a la misma din√°mica: sedaci√≥n mayor ‚Üí obstrucci√≥n ‚Üí crisis. Si decides continuar, el mitigador es reforzar monitorizaci√≥n (capnograf√≠a), soporte de v√≠a a√©rea, y criterios claros de parada ante deterioro.",
        kpi:[]
      }
    }
  },

  S5: {
    scene: `Minuto 27. Se reanuda (con pausa breve). A los 2‚Äì3 minutos, el paciente vuelve a roncar, capnograf√≠a cae, SpO‚ÇÇ 92%‚Üí88%.
    La enfermera dice: ‚Äúla v√≠a venosa est√° en el brazo contralateral, cuesta acceso‚Äù.`,
    meta: ["Reca√≠da predecible", "Limitaci√≥n de accesos", "Necesitas plan sostenido"],
    A: {
      txt: "Escalas el plan: decides asegurar v√≠a a√©rea (p.ej., LMA) para estabilidad ventilatoria y coordinar con el equipo un ‚Äústop moment‚Äù para colocaci√≥n segura.",
      to: "S6",
      fb: {
        kind:"clinica",
        title:"Controlas la variable inestable",
        body:"En NORA, cuando la ventilaci√≥n es la variable fr√°gil, asegurar v√≠a a√©rea puede ser m√°s seguro que ‚Äúmicroajustar‚Äù sedaci√≥n. La clave es coordinar ventana de seguridad, equipo y roles, y anticipar reversi√≥n/recuperaci√≥n.",
        kpi:["SeguridadNORA","Liderazgo"]
      }
    },
    B: {
      txt: "Decides ‚Äúaguantar‚Äù con maniobras intermitentes (jaw thrust) mientras el operador avanza, sin asegurar v√≠a a√©rea.",
      to: "S6",
      fb: {
        kind:"seguridad",
        title:"Estrategia de contenci√≥n",
        body:"Puede funcionar en algunos casos, pero es fr√°gil y dependiente del operador/posici√≥n. El riesgo principal es la fatiga del equipo y una nueva ca√≠da s√∫bita con acceso comprometido. Si eliges esta ruta, exige alta disciplina de reevaluaci√≥n y umbrales de parada.",
        kpi:["Reevaluacion"]
      }
    }
  },

  S6: {
    scene: `Minuto 29. Durante el intento de estabilizar, ocurre un evento m√°s severo: capnograf√≠a desaparece, SpO‚ÇÇ 78%.
    PANI cae a 82/48, FC 52. El paciente est√° fl√°cido. El entorno se vuelve ruidoso: varias personas hablan al mismo tiempo.`,
    meta: ["Crisis combinada: ventilaci√≥n + hemodinamia", "Riesgo de fijaci√≥n atencional", "Necesitas equipo alineado"],
    A: {
      txt: "Haces ‚Äúanuncio de crisis‚Äù y asignas roles: 1) v√≠a a√©rea/ventilaci√≥n, 2) f√°rmacos/IV, 3) monitorizaci√≥n/tiempos, 4) comunicaci√≥n con procedimiento. Pides silencio operativo y bucle cerrado.",
      to: "S7",
      fb: {
        kind:"equipo",
        title:"Restauras estructura en el caos",
        body:"Esto es CRM puro: al declarar crisis y repartir tareas, reduces interferencia y duplicidad. El silencio operativo y el closed-loop permiten detectar r√°pido si la intervenci√≥n est√° funcionando.",
        kpi:["Liderazgo","ClosedLoop","LlamarAyuda"]
      }
    },
    B: {
      txt: "Te concentras solo en intubar/ventilar sin verbalizar roles ni prioridades; el equipo sigue hablando y actuando sin coordinaci√≥n.",
      to: "S7",
      fb: {
        kind:"crm",
        title:"Alta carga cognitiva sin contenci√≥n del sistema",
        body:"No ‚Äúest√° mal‚Äù enfocarte en la v√≠a a√©rea, pero el costo puede ser que nadie gestione f√°rmacos/IV/tiempos ni contenga el entorno. En NORA, el sistema sin coordinaci√≥n tiende a empeorar tu desempe√±o t√©cnico.",
        kpi:[]
      }
    }
  },

  S7: {
    scene: `Minuto 30. Ventilas con bolsa-mascarilla: el t√≥rax apenas se eleva; la presi√≥n es alta.
    Consideras dos posibilidades: 1) obstrucci√≥n severa/laringoespasmo, 2) broncoespasmo/hiperinflaci√≥n. SpO‚ÇÇ 76%. PANI 78/44.`,
    meta: ["Necesitas una hip√≥tesis operativa", "Intervenir sin retrasar", "Evitar fijaci√≥n"],
    A: {
      txt: "Act√∫as por algoritmo: optimizas ventilaci√≥n y tratas laringoespasmo/obstrucci√≥n (presi√≥n positiva, profundizar anestesia si seguro, considerar relajante si no ventila), mientras confirmas capnograf√≠a y revisas r√°pidamente equipo/circuito.",
      to: "S8",
      fb: {
        kind:"clinica",
        title:"Intervenci√≥n paralela con verificaci√≥n de sistema",
        body:"En crisis respiratoria, revisar ‚Äòm√°quina‚Äìcircuito‚Äìpaciente‚Äô evita pasar por alto causas corregibles. La intervenci√≥n debe ser simult√°nea y priorizar ‚Äòventilar ahora‚Äô.",
        kpi:["Reevaluacion","SeguridadNORA"]
      }
    },
    B: {
      txt: "Asumes broncoespasmo y administras broncodilatador sin priorizar ventilaci√≥n efectiva ni revisar circuito/equipo.",
      to: "S8",
      fb: {
        kind:"clinica",
        title:"Hip√≥tesis √∫nica temprana",
        body:"Dar broncodilatador puede ser √∫til, pero si no hay ventilaci√≥n efectiva (y capnograf√≠a ausente), el tratamiento farmacol√≥gico aislado no resuelve el problema inmediato. El aprendizaje es evitar ‚Äòdiagn√≥stico t√∫nel‚Äô bajo estr√©s.",
        kpi:[]
      }
    }
  },

  S8: {
    scene: `Minuto 31. Con intervenci√≥n activa, recuperas algo de ventilaci√≥n: aparece capnograf√≠a peque√±a, SpO‚ÇÇ 80%‚Üí86%.
    La presi√≥n arterial sigue baja. El operador pregunta si debe cancelar. El equipo espera tu decisi√≥n.`,
    meta: ["Mejor√≠a parcial", "Hipotensi√≥n persistente", "Decisi√≥n de continuar vs abortar"],
    A: {
      txt: "Defines: ‚ÄúSe aborta temporalmente. Estabilizamos ventilaci√≥n y hemodinamia primero; luego reevaluamos riesgo/beneficio.‚Äù Solicitas traslado a entorno con mayor control (OR o sala de recuperaci√≥n avanzada) si procede.",
      to: "S9",
      fb: {
        kind:"seguridad",
        title:"Priorizas estabilizaci√≥n y entorno adecuado",
        body:"En NORA, cambiar de entorno (mejor acceso, m√°s recursos) puede ser la intervenci√≥n definitiva de seguridad. Suspender temporalmente no es ‚Äòfracaso‚Äô: es control de riesgo.",
        kpi:["Liderazgo","SeguridadNORA"]
      }
    },
    B: {
      txt: "Decides continuar porque ‚Äúya casi terminan‚Äù, manteniendo soporte ventilatorio y tratando la hipotensi√≥n al mismo tiempo en el mismo sitio.",
      to: "S9",
      fb: {
        kind:"seguridad",
        title:"Continuidad con riesgo residual alto",
        body:"Puede ser defendible solo si la estabilizaci√≥n es robusta y el plan de rescate est√° listo. Si la mejor√≠a es fr√°gil, la probabilidad de reca√≠da durante un paso cr√≠tico puede superar el beneficio de terminar.",
        kpi:[]
      }
    }
  },

  S9: {
    scene: `Minuto 34. Tras medidas, SpO‚ÇÇ 95% con ventilaci√≥n asistida; PANI 96/58 tras fluidos/vasopresor titulado.
    Ahora viene la parte de ‚Äúcierre‚Äù: comunicar, documentar y aprender. El equipo est√° cansado y el √°rea quiere ‚Äúvolver a la normalidad‚Äù.`,
    meta: ["Riesgo de ‚Äònormalizaci√≥n‚Äô", "Necesidad de cierre seguro", "Aprendizaje del evento"],
    A: {
      txt: "Haces cierre estructurado de 2‚Äì3 min: resumen del evento, acciones clave, estatus actual, plan de vigilancia/traslado, y registras en nota y reporte de evento (seg√∫n pol√≠tica local). Mini-debrief inmediato.",
      to: "END_GOOD",
      fb: {
        kind:"proceso",
        title:"Cierre seguro y cultura de aprendizaje",
        body:"El ‚Äòfinish‚Äô es parte del manejo de crisis: comunicaci√≥n final evita errores de continuidad (PACU, traslado, handoff). El mini-debrief fortalece factor humano y reduce repetici√≥n de fallas latentes.",
        kpi:["Checklists","ClosedLoop"]
      }
    },
    B: {
      txt: "Das por terminado el tema sin resumen; pides ‚Äúvigilar en recuperaci√≥n‚Äù y te retiras para el siguiente caso.",
      to: "END_WARN",
      fb: {
        kind:"crm",
        title:"Cierre incompleto",
        body:"Es com√∫n por presi√≥n de flujo, pero incrementa riesgo de fallas en el handoff y pierde oportunidades de aprendizaje. Si no hay tiempo para debrief, al menos un resumen cl√≠nico y plan expl√≠cito de vigilancia/alarma es cr√≠tico.",
        kpi:[]
      }
    }
  },

  END_GOOD: {
    end: true,
    endClass: "endbox",
    title: "Fin del caso ‚Äì Control de crisis con enfoque en factor humano",
    debrief: `
      <p><b>Qu√© decisiones tuvieron mayor impacto:</b></p>
      <ul>
        <li><b>Reconocer se√±ales tempranas</b> (capnograf√≠a/ronquido) y actuar antes de la desaturaci√≥n severa.</li>
        <li><b>Declarar prioridad y liberar acceso</b> (pausa del procedimiento, retirar arco/equipo que bloquea).</li>
        <li><b>Asignar roles y usar closed-loop</b> para sostener rendimiento bajo estr√©s.</li>
        <li><b>Definir umbrales para reanudar</b> y considerar cambiar el plan (p.ej., asegurar v√≠a a√©rea) cuando la ventilaci√≥n es fr√°gil.</li>
        <li><b>Cierre estructurado</b>: handoff seguro + aprendizaje (mini-debrief).</li>
      </ul>
      <p><b>Sesgos/fallas humanas t√≠picas en NORA (a vigilar):</b> fijaci√≥n en ‚Äúno interrumpir‚Äù, normalizaci√≥n del desv√≠o, diagn√≥stico t√∫nel, y comunicaci√≥n no dirigida.</p>
      <p><b>Pregunta para pensamiento cr√≠tico:</b> En tu entorno real de NORA, ¬øcu√°l es el <i>umbral operativo</i> (SpO‚ÇÇ, EtCO‚ÇÇ, acceso, recursos disponibles) que justifica convertir a anestesia general o cambiar de sala, y c√≥mo lo comunicar√≠as en 15 segundos sin generar conflicto?</p>
    `
  },

  END_WARN: {
    end: true,
    endClass: "endbox warnline",
    title: "Fin del caso ‚Äì Crisis resuelta, pero con vulnerabilidades residuales",
    debrief: `
      <p><b>Resultado:</b> el paciente se estabiliza, pero quedaron <b>riesgos de continuidad</b> (handoff menos expl√≠cito, aprendizaje perdido, y mayor probabilidad de repetici√≥n de fallas latentes).</p>
      <p><b>Oportunidad de mejora de alto rendimiento:</b></p>
      <ul>
        <li>Establecer un <b>brief est√°ndar NORA</b> (roles, recursos, umbrales) incluso cuando ‚Äúhay prisa‚Äù.</li>
        <li>Usar <b>frases gatillo</b>: ‚ÄúPausa. Prioridad: ventilar‚Äù, ‚ÄúYo lidero v√≠a a√©rea‚Äù, ‚ÄúCriterios para reanudar: ‚Ä¶‚Äù.</li>
        <li>Cerrar con <b>resumen + plan</b> (monitorizaci√≥n, traslado, vigilancia) aunque sea en 30‚Äì60 s.</li>
      </ul>
      <p><b>Pregunta para pensamiento cr√≠tico:</b> ¬øQu√© elemento del sistema (personal, equipo, layout, protocolo, cultura) fue el ‚Äúpunto de falla‚Äù m√°s importante, y cu√°l es una intervenci√≥n de bajo costo que podr√≠as implementar esta semana?</p>
    `
  }
};

function render(nodeId){
  const n = nodes[nodeId];
  state.step = nodeId;

  const sceneEl = document.getElementById("scene");
  const metaEl  = document.getElementById("meta");
  const aBtn    = document.getElementById("aBtn");
  const bBtn    = document.getElementById("bBtn");
  const fbBox   = document.getElementById("fb");
  const debriefCard = document.getElementById("debriefCard");

  fbBox.style.display = "none";
  debriefCard.style.display = "none";

  sceneEl.innerHTML = n.scene;
  metaEl.innerHTML = "";
  (n.meta||[]).forEach(m=>{
    const d=document.createElement("div");
    d.textContent=m;
    metaEl.appendChild(d);
  });

  if(n.end){
    aBtn.style.display="none";
    bBtn.style.display="none";
    showDebrief(n);
    return;
  }

  aBtn.style.display="block";
  bBtn.style.display="block";

  aBtn.textContent = "A) " + n.A.txt;
  bBtn.textContent = "B) " + n.B.txt;

  aBtn.onclick = ()=> choose("A");
  bBtn.onclick = ()=> choose("B");
}

function choose(opt){
  const n = nodes[state.step];
  const choice = n[opt];
  addLog(`Paso ${state.step} ‚Äì Elegiste ${opt}: ${choice.txt}`);

  // feedback
  showFeedback(choice.fb);

  // KPIs
  (choice.fb.kpi||[]).forEach(bump);

  // advance
  setTimeout(()=> render(choice.to), 700); // breve pausa para que se lea feedback
}

function showFeedback(fb){
  const fbBox = document.getElementById("fb");
  const fbEmoji = document.getElementById("fbEmoji");
  const fbTitle = document.getElementById("fbTitle");
  const fbTag   = document.getElementById("fbTag");
  const fbBody  = document.getElementById("fbBody");

  const t = tagFor(fb.kind);
  fbEmoji.textContent = t.emoji;
  fbTitle.textContent = fb.title || "Retroalimentaci√≥n";
  fbTag.textContent   = t.tag;
  fbBody.textContent  = fb.body || "";

  fbBox.style.display = "block";
}

function renderLog(){
  const logEl = document.getElementById("log");
  logEl.innerHTML = "";
  state.log.slice().reverse().forEach(x=>{
    const p=document.createElement("p");
    p.textContent = x;
    logEl.appendChild(p);
  });
}

function renderKpi(){
  const k = state.kpi;
  const kpis = document.getElementById("kpis");
  kpis.innerHTML = "";
  const entries = [
    ["LlamarAyuda","Escalamiento/ayuda"],
    ["Liderazgo","Liderazgo"],
    ["ClosedLoop","Closed-loop"],
    ["Reevaluacion","Reevaluaci√≥n"],
    ["SeguridadNORA","Seguridad NORA"],
    ["Checklists","Proceso/checklist"]
  ];
  entries.forEach(([key,label])=>{
    const s=document.createElement("span");
    s.textContent = `${label}: ${k[key]||0}`;
    kpis.appendChild(s);
  });
}

function showDebrief(endNode){
  const debriefCard = document.getElementById("debriefCard");
  const debrief = document.getElementById("debrief");

  debriefCard.style.display = "block";
  debrief.className = endNode.endClass || "endbox";
  debrief.innerHTML = `<p><b>${endNode.title}</b></p>` + endNode.debrief;

  addLog(`FIN ‚Äì ${endNode.title}`);
}

document.getElementById("restartBtn").onclick = ()=>{
  state.step="S0";
  state.log=[];
  state.kpi = {LlamarAyuda:0,Liderazgo:0,ClosedLoop:0,Reevaluacion:0,SeguridadNORA:0,Checklists:0};
  document.getElementById("aBtn").style.display="block";
  document.getElementById("bBtn").style.display="block";
  render("S0");
  renderKpi();
  renderLog();
};

document.getElementById("toggleLogBtn").onclick = ()=>{
  const logEl = document.getElementById("log");
  logEl.style.display = (logEl.style.display==="none") ? "block" : "none";
};

render("S0");
renderKpi();
</script>
</body>
</html>
